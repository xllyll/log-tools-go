<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝鲸智联日志分析工具</title>
    <link rel="stylesheet" href="/static/element-ui/index.css">
    <link rel="stylesheet" href="/static/css/index.css?v=2025">
    <link rel="stylesheet" href="/static/css/loading.css?v=2025">
    <link rel="stylesheet" href="/static/highlight/styles/vs2015.css">
    <script src="/static/js/vue.js"></script>
    <script src="/static/element-ui/index.js"></script>
    <script src="/static/js/request.js"></script>
    <script src="/static/components/log-view.js"></script>
    <script src="/static/components/header.js"></script>
    <script src="/static/components/upload.js"></script>
    <script src="/static/components/index.js"></script>
    <script src="/static/highlight/highlight.min.js"></script>
    <script src="/static/js/marked.umd.js"></script>
    <script src="/static/marked-highlight/index.umd.js"></script>
    <script src="/static/js/gen.js"></script>
</head>
<body>
<div id="app" class="app-container">
    <log-header-view
        @on-setting="showSettings"
        @dark-mode-toggle="toggleDarkMode"
    ></log-header-view>
    <div class="main-content">
        <div class="sidebar">
            <el-container style="height: 100%;">
                <el-main style="padding: 20px;">
                    <el-tabs v-model="activeTab">
                        <el-tab-pane label="上传日志" name="upload">
                            <el-card style="margin-bottom: 20px;" v-loading="uploading">
                                <div slot="header">上传日志文件</div>
                                <el-form>
                                    <el-form-item label="选择项目">
                                        <el-select v-model="selectedProjectName" placeholder="请选择项目" @change="onSelectProject"
                                                   style="width: 200px;">
                                            <el-option v-for="(p,index) in projectList" :key="index"
                                                       :label="p.project_name"
                                                       :value="p.project_name">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item label="上传日志">
                                        <upload-view :uploading.sync="uploading" :project-name="selectedProjectName" @upload-success="handleUploadSuccess"/>
                                    </el-form-item>
                                </el-form>
                            </el-card>
                        </el-tab-pane>
                        <el-tab-pane label="日志管理" name="settings">
                            <el-card>
                                <div slot="header">过滤设置</div>
                                <el-form :model="filterForm" size="mini" label-width="80px">
                                    <el-form-item label="日志级别">
                                        <el-select multiple placeholder="请选择日志级别" style="width: 100%;" v-model="filterForm.levels">
                                            <el-option v-for="(node,index) in availableLevels" :key="index" :value="node.level" :label="node.level"/>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item label="模块">
                                        <el-select clearable placeholder="请选择日志模块" style="width: 100%;" v-model="filterForm.module" @change="onSelectModule">
                                            <el-option v-for="(module,m_index) in selectedProject.modules" :key="m_index" :value="module.name" :label="module.name"/>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item label="场景">
                                        <el-select clearable placeholder="请选择日志模块" style="width: 100%;" v-model="selectedSceneName" @change="onSelectModuleScene">
                                            <el-option v-for="(scene,s_index) in ((selectedModule && selectedModule.scenes)?selectedModule.scenes : [])" :key="s_index" :value="scene.name" :label="scene.name"/>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item label="关键词">
                                        <el-input v-model="filterForm.keywords" placeholder="输入关键词搜索" clearable>
                                        </el-input>
                                    </el-form-item>
                                    <el-form-item label="查询筛选">
                                        <el-checkbox v-model="filterForm.useRegex">正则匹配</el-checkbox>
                                    </el-form-item>
                                </el-form>
                                <el-button type="primary" style="width: 100%;" @click="applyFilter">搜索
                                </el-button>
                            </el-card>
                            <el-card style="margin-top: 20px;" v-loading="batchDeleting">
                                <div slot="header">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>已上传文件</span>
                                        <div>
                                            <el-checkbox
                                                v-if="files.length > 0"
                                                v-model="selectAll"
                                                @change="handleSelectAllChange"
                                                style="margin-right: 10px;"
                                            >
                                                全选
                                            </el-checkbox>
                                            <el-button
                                                v-if="selectedFileIds.length > 0"
                                                type="danger"
                                                size="mini"
                                                @click="batchRemoveFiles"
                                                :disabled="batchDeleting"
                                            >
                                                批量删除({{ selectedFileIds.length }})
                                            </el-button>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="files.length === 0">暂无文件</div>
                                <div v-else>
                                    <div v-for="(file,index) in files" :key="index" class="file-list"
                                         :class="{select: selectedFileIds.includes(file.id)}"
                                         @click.stop="toggleFileSelection(file.id)">
                                        <div style="display: flex; align-items: center;">
                                            <el-checkbox
                                                :value="selectedFileIds.includes(file.id)"
                                                @change.stop="(val) => handleFileSelectChange(val, file.id)"
                                                @click.stop
                                                style="margin-right: 10px;">
                                            </el-checkbox>
                                            <div style="flex: 1;">
                                                <span style="margin: 0;word-break: break-all;">{{ file.name }}</span>
                                                <div class="flex-row-center mt-5"
                                                     style="width:100%;justify-content: space-between;">
                                                    <span style="margin: 0; color: #909399;">{{ formatFileSize(file.size) }} • {{ file.total }} 条日志</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="delete-file-btn"  @click.stop="removeFile(file.id)">
                                            <i class="el-icon-close" style="color: #fff"></i>
                                        </div>
                                    </div>
                                </div>
                            </el-card>
                        </el-tab-pane>
                    </el-tabs>
                </el-main>
            </el-container>
        </div>
        <div class="content-area">
            <el-card style="width: 100%; min-height: 560px;" v-loading="loading">
                <div slot="header" class="clearfix">
                    <span>日志内容 总数:{{ totalLogs }}</span>
                    <el-button style="float: right; padding: 3px 0" type="text" @click.stop="analyzeLogs">AI分析</el-button>
                </div>
                <div v-if="loading">正在加载日志...</div>
                <div v-if="!currentFileId">请上传日志文件开始分析</div>
                <div v-if="currentFileId && logs.length === 0">
                    <el-empty description="暂无数据"></el-empty>
                </div>
                <div v-if="currentFileId && logs.length > 0">
                    <el-collapse accordion>
                        <el-collapse-item v-for="(log,index) in logs" :name="index" :key="index">
                            <template #title="{ isActive }">
                                <div class="log-entry" :class="{active:isActive}"
                                     :style="{borderLeft:getLevelColor(log.level)}">
                                    <div class="flex-row"
                                         style="font-size: 14px;white-space: nowrap;overflow: hidden;align-items: center;">
                                        <span class="log-message-time"
                                              v-if="!settingForm.showAll && settingForm.showTime">{{ formatTime(log.log_time) }}</span>
                                        <div class="log-message-thread" v-if="!settingForm.showAll && settingForm.showThread"
                                             :style="{color:settingForm.threadColor}">[{{ log.thread }}]
                                        </div>
                                        <div class="log-message-level" v-if="!settingForm.showAll && settingForm.showModule"
                                             :style="{color:settingForm.moduleColor}">[{{ log.module }}]
                                        </div>
                                        <div class="log-message-class" v-if="!settingForm.showAll && settingForm.showClass"
                                             :style="{color:settingForm.classColor}">[{{ log.class }}]
                                        </div>
                                        <div v-if="settingForm.showAll" style="flex: 1;padding-left: 2px;"
                                             :style="{color: settingForm.color}"
                                             v-html="highlightKeywords(log.content)">
                                        </div>
                                        <div v-else style="flex: 1;padding-left: 2px;"
                                             :style="{color: settingForm.color}"
                                             v-html="highlightKeywords(log.message)">
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div class="log-message" v-html="highlightKeywords(log.content)">
                            </div>
                        </el-collapse-item>
                    </el-collapse>

                    <div class="page-footer">
                        <el-pagination
                                v-if="totalLogs > 0"
                                @size-change="handleSizeChange"
                                @current-change="handlePageChange"
                                :current-page="currentPage + 1"
                                :page-size="pageSize"
                                :page-sizes="[100, 200, 500, 1000]"
                                layout="sizes,prev, pager, next, total"
                                :total="totalLogs"
                                style="margin-top: 20px; text-align: center;">
                        </el-pagination>
                        <div style="margin-top: 10px; text-align: center;">
                            <el-button
                                v-if="selectedFileIds.length > 1 && selectedFileIds.length !== files.length"
                                type="primary"
                                size="small"
                                @click="loadLogs"
                                :disabled="loading">
                                查询选中的 {{ selectedFileIds.length }} 个文件
                            </el-button>
                        </div>
                    </div>
                </div>
            </el-card>
        </div>
    </div>
    <el-dialog :visible.sync="showDialog" title="设置" width="80vw">
        <el-tabs>
            <el-tab-pane label="日志颜色">
                <el-card>
                    <el-form ref="form" :model="settingForm" label-width="80px">
                        <!-- 日志颜色 -->
                        <el-row>
                            <el-col :span="8">
                                <el-form-item label="日志颜色">
                                    <el-color-picker v-model="settingForm.color" show-alpha></el-color-picker>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="线程颜色">
                                    <el-color-picker v-model="settingForm.threadColor" show-alpha></el-color-picker>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="类名颜色">
                                    <el-color-picker v-model="settingForm.classColor" show-alpha></el-color-picker>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-form-item label="等级">
                            <div class="flex-row">
                                <div class="level-color-set" v-for="(value,key) in levelColorMap">
                                    <span style="margin: 0 5px;">{{ key }}</span>
                                    <el-color-picker v-model="levelColorMap[key]" show-alpha></el-color-picker>
                                </div>
                            </div>
                        </el-form-item>
                        <el-row>
                            <el-col :span="8">
                                <el-form-item label="显示时间">
                                    <el-switch v-model="settingForm.showTime" active-text="显示"
                                               inactive-text="隐藏"></el-switch>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="显示模块">
                                    <el-switch v-model="settingForm.showModule" active-text="显示"
                                               inactive-text="隐藏"></el-switch>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="显示线程">
                                    <el-switch v-model="settingForm.showThread" active-text="显示"
                                               inactive-text="隐藏"></el-switch>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="显示类名">
                                    <el-switch v-model="settingForm.showClass" active-text="显示" inactive-text="隐藏"></>
                                </el-form-item>
                            </el-col>
                        </el-row>


                    </el-form>
                </el-card>
            </el-tab-pane>
            <el-tab-pane label="项目配置">
                <el-card style="height: 70vh;">
                    <div  slot="header" style="text-align: start;">
                        <el-button type="success" @click="showAddProjectDialog" icon="el-icon-plus">新增项目</el-button>
                        <el-button type="primary" @click="saveProjectConfig" icon="el-icon-check">保存配置</el-button>
                    </div>
                    <!-- 项目配置列表 -->
                    <el-table :data="projectList" style="width: 100%" stripe>
                        <el-table-column prop="project_name" label="项目名称" width="200"></el-table-column>
                        <el-table-column prop="rule.timestamp" label="时间正则" width="200"></el-table-column>
                        <el-table-column prop="rule.level" label="级别正则" width="200"></el-table-column>
                        <el-table-column prop="rule.module" label="模块正则" width="200"></el-table-column>
                        <el-table-column label="操作" width="200">
                            <template slot-scope="scope">
                                <el-button size="mini" @click="showEditProjectDialog(scope.row, scope.$index)">编辑</el-button>
                                <el-button size="mini" type="danger" @click="deleteProject(scope.$index)">删除</el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </el-card>
            </el-tab-pane>
            <el-tab-pane label="AI日志正则">
                <el-card>
                    <div v-if="aiLoading===false && (!aiRuleRes || aiRuleRes==='')">
                        <span>提示：请输入日志示例</span>
                        <el-input v-model="logExample"></el-input>
                        <el-form :model="logRuleSet" label-width="80px">
                            <el-form-item label="时间">
                                <el-input v-model="logRuleSet.time"></el-input>
                            </el-form-item>
                            <el-form-item label="线程">
                                <el-input v-model="logRuleSet.thread"></el-input>
                            </el-form-item>
                            <el-form-item label="类名">
                                <el-input v-model="logRuleSet.class"></el-input>
                            </el-form-item>
                            <el-form-item label="等级">
                                <el-input v-model="logRuleSet.level"></el-input>
                            </el-form-item>
                            <el-form-item label="内容">
                                <el-input v-model="logRuleSet.message"></el-input>
                            </el-form-item>
                        </el-form>
                    </div>
                    <div style="width: 100%;display: flex;flex-direction: column;align-items: center;justify-content: center;">
                        <div v-if="aiLoading" class="loader"></div>
                        <div v-if="aiRuleRes">
                            <i class="el-icon-success" style="font-size: 64px;color: #13ce66;"></i>
                            <div class="" style="white-space: pre-line;">
                                <div v-html="buildMarkdownCode(aiRuleRes)"></div>
                            </div>
                        </div>
                    </div>
                    <el-button v-if="!aiRuleRes || aiRuleRes===''" type="primary" style="margin-top: 20px;width: 100%;"
                               @click="aiGenerateLogRule">AI生成
                    </el-button>
                    <el-button v-if="aiRuleRes && aiRuleRes!==''" type="primary" style="margin-top: 20px;width: 100%;"
                               @click="resetGenerateLogRule">重新生成
                    </el-button>
                </el-card>
            </el-tab-pane>
        </el-tabs>
    </el-dialog>
    <el-dialog :visible.sync="projectDialogVisible" title="项目配置" width="80vw" :before-close="handleProjectDialogClose">
        <el-form :model="currentProject" label-width="120px" ref="projectForm">
            <el-card shadow="hover" style="margin-bottom: 15px;">
                <div slot="header" class="clearfix">
                    <span style="font-weight: bold;">基础配置</span>
                </div>
                <el-form-item label="项目名称" prop="project_name" :rules="{ required: true, message: '请输入项目名称', trigger: 'blur' }">
                    <el-input v-model="currentProject.project_name" placeholder="请输入项目名称"></el-input>
                </el-form-item>
            </el-card>

            <el-card shadow="hover" style="margin-bottom: 15px;">
                <div slot="header" class="clearfix">
                    <span style="font-weight: bold;">解析规则</span>
                </div>
                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="时间正则">
                            <el-input v-model="currentProject.rule.timestamp" placeholder="时间正则表达式"></el-input>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="时间格式">
                            <el-input v-model="currentProject.rule.timestamp_format" placeholder="时间格式"></el-input>
                        </el-form-item>
                    </el-col>
                </el-row>

                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="进程正则">
                            <el-input v-model="currentProject.rule.process" placeholder="进程正则表达式"></el-input>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="线程正则">
                            <el-input v-model="currentProject.rule.thread" placeholder="线程正则表达式"></el-input>
                        </el-form-item>
                    </el-col>
                </el-row>

                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="日志级别正则">
                            <el-input v-model="currentProject.rule.level" placeholder="日志级别正则表达式"></el-input>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="模块正则">
                            <el-input v-model="currentProject.rule.module" placeholder="模块正则表达式"></el-input>
                        </el-form-item>
                    </el-col>
                </el-row>

                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="类名正则">
                            <el-input v-model="currentProject.rule.class" placeholder="类名正则表达式"></el-input>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="类行号正则">
                            <el-input v-model="currentProject.rule.class_line" placeholder="类行号正则表达式"></el-input>
                        </el-form-item>
                    </el-col>
                </el-row>

                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="标签正则">
                            <el-input v-model="currentProject.rule.tag" placeholder="标签正则表达式"></el-input>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="消息正则">
                            <el-input v-model="currentProject.rule.message" placeholder="消息正则表达式"></el-input>
                        </el-form-item>
                    </el-col>
                </el-row>
            </el-card>

            <el-card shadow="hover">
                <div slot="header" class="clearfix">
                    <span style="font-weight: bold;">模块配置</span>
                    <el-button style="float: right; padding: 3px 0" type="primary" icon="el-icon-plus" @click="addModule(currentProject)">添加模块</el-button>
                </div>

                <div v-for="(module, mIndex) in currentProject.modules" :key="mIndex" style="margin-bottom: 15px;">
                    <el-card shadow="hover">
                        <div slot="header" class="clearfix">
                            <span>模块 {{ mIndex+1 }}</span>
                            <el-button style="float: right; padding: 3px 0" type="text" @click="currentProject.modules.splice(mIndex, 1)">删除模块</el-button>
                        </div>

                        <el-form-item label="模块名称">
                            <el-input v-model="module.name" placeholder="请输入模块名称"></el-input>
                        </el-form-item>

                        <div style="margin: 15px 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-weight: bold;">场景配置</span>
                                <el-button type="primary" icon="el-icon-plus" @click="addScene(module)">添加场景</el-button>
                            </div>

                            <div v-for="(scene, sIndex) in module.scenes" :key="sIndex" style="margin-bottom: 10px;">
                                <el-card>
                                    <div slot="header" class="clearfix">
                                        <span>场景 {{ sIndex+1 }}</span>
                                        <el-button style="float: right; padding: 3px 0" type="text" @click="module.scenes.splice(sIndex, 1)">删除场景</el-button>
                                    </div>

                                    <el-form-item label="场景名称">
                                        <el-input v-model="scene.name" placeholder="请输入场景名称"></el-input>
                                    </el-form-item>

                                    <div style="margin: 15px 0;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <span style="font-weight: bold;">关键词配置</span>
                                            <el-button type="primary" icon="el-icon-plus" @click="addKeyword(scene)">添加关键词</el-button>
                                        </div>

                                        <div v-for="(keyword, kIndex) in scene.keywords" :key="kIndex" style="margin-bottom: 10px;">
                                            <el-card>
                                                <el-row :gutter="10" style="align-items: center;">
                                                    <el-col :span="5">
                                                        <el-input v-model="keyword.keyword" placeholder="关键词"></el-input>
                                                    </el-col>
                                                    <el-col :span="4">
                                                        <el-select v-model="keyword.mode" placeholder="匹配模式" style="width: 100%;">
                                                            <el-option label="单词匹配" value="word"></el-option>
                                                            <el-option label="正则匹配" value="regular"></el-option>
                                                        </el-select>
                                                    </el-col>
                                                    <el-col :span="7">
                                                        <el-input v-model="keyword.desc" placeholder="描述"></el-input>
                                                    </el-col>
                                                    <el-col :span="5">
                                                        <el-color-picker v-model="keyword.color" show-alpha></el-color-picker>
                                                    </el-col>
                                                    <el-col :span="3">
                                                        <el-button type="danger" icon="el-icon-delete" circle @click="scene.keywords.splice(kIndex, 1)"></el-button>
                                                    </el-col>
                                                </el-row>
                                            </el-card>
                                        </div>
                                    </div>
                                </el-card>
                            </div>
                        </div>
                    </el-card>
                </div>
            </el-card>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @click="projectDialogVisible = false">取 消</el-button>
            <el-button type="primary" @click="saveProject">确 定</el-button>
        </div>
    </el-dialog>
    <el-dialog :visible.sync="aiShow" title="AI日志分析" width="80vw">
        <el-card style="height: 70vh;">
            <div ref="aiContentRef" style="width:100%;height:calc(70vh - 40px);overflow-y: auto;">
                <div v-if="aiMessages.length > 0" style="width: 100%">
                    <template v-for="msg in aiMessages">
                        <div class="ai-message" :class="{user:msg.role=='user'}" style="white-space: pre-line;">
                            <div class="ai-message-box" :class="{user:msg.role=='user'}"
                                 v-html="buildMarkdownCode(msg.content)"></div>
                        </div>
                    </template>
                    <div v-if="aiRes && aiRes.length>0" class="ai-message" style="white-space: pre-line;">
                        <div class="ai-message-box"
                             v-html="buildMarkdownCode(aiRes)"></div>
                    </div>
                </div>
            </div>
        </el-card>
        <el-card>
            <div class="flex-row">
                <el-input v-model="aiMessage" placeholder="输入关键你要提问的问题..."></el-input>
                <el-button type="primary" v-loading="aiLoading" style="width: 80px;margin-left: 10px;" @click="handleAiMessageSend">发送</el-button>
            </div>
        </el-card>
    </el-dialog>
</div>
<script>hljs.highlightAll();</script>
<script src="/static/js/app.js?v=2025"></script>
</body>
</html>
