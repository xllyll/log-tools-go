<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝鲸智联日志分析工具</title>
    <link rel="stylesheet" href="/static/element-ui/index.css">
    <link rel="stylesheet" href="/static/css/index.css?v=2025">
    <link rel="stylesheet" href="/static/css/loading.css?v=2025">
    <link rel="stylesheet" href="/static/highlight/styles/vs2015.css">
    <script src="/static/js/vue.js"></script>
    <script src="/static/element-ui/index.js"></script>
    <script src="/static/js/request.js"></script>
    <script src="/static/components/log-view.js"></script>
    <script src="/static/components/header.js"></script>
    <script src="/static/components/upload.js"></script>
    <script src="/static/components/index.js"></script>
    <script src="/static/highlight/highlight.min.js"></script>
    <script src="/static/js/marked.umd.js"></script>
    <script src="/static/marked-highlight/index.umd.js"></script>
    <script src="/static/js/gen.js"></script>
</head>
<body>
<div id="app" class="app-container">
    <log-header-view
        @on-setting="showSettings"
        @dark-mode-toggle="toggleDarkMode"
    ></log-header-view>
    <div class="main-content">
        <div class="sidebar">
            <el-container style="height: 100%;">
                <el-main style="padding: 20px;">
                    <el-tabs v-model="activeTab">
                        <el-tab-pane label="上传日志" name="upload">
                            <el-card style="margin-bottom: 20px;" v-loading="uploading">
                                <div slot="header">上传日志文件</div>
                                <el-form>
                                    <el-form-item label="选择项目">
                                        <el-select v-model="selectedProjectName" placeholder="请选择项目" @change="onSelectProject"
                                                   style="width: 200px;">
                                            <el-option v-for="(p,index) in projectList" :key="index"
                                                       :label="p.project_name"
                                                       :value="p.project_name">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item label="上传日志">
                                        <upload-view :uploading.sync="uploading" :project-name="selectedProjectName" @upload-success="handleUploadSuccess"/>
                                    </el-form-item>
                                </el-form>
                            </el-card>
                        </el-tab-pane>
                        <el-tab-pane label="日志管理" name="settings">
                            <el-card>
                                <div slot="header">过滤设置</div>
                                <el-form :model="filterForm" size="mini" label-width="80px">
                                    <el-form-item label="日志级别">
                                        <el-select multiple placeholder="请选择日志级别" style="width: 100%;" v-model="filterForm.levels">
                                            <el-option v-for="(node,index) in availableLevels" :key="index" :value="node.level" :label="node.level"/>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item label="模块">
                                        <el-select clearable placeholder="请选择日志模块" style="width: 100%;" v-model="filterForm.module" @change="onSelectModule">
                                            <el-option v-for="(module,m_index) in selectedProject.modules" :key="m_index" :value="module.name" :label="module.name"/>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item label="场景">
                                        <el-select clearable placeholder="请选择日志模块" style="width: 100%;" v-model="selectedSceneName" @change="onSelectModuleScene">
                                            <el-option v-for="(scene,s_index) in ((selectedModule && selectedModule.scenes)?selectedModule.scenes : [])" :key="s_index" :value="scene.name" :label="scene.name"/>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item label="关键词">
                                        <el-input v-model="filterForm.keywords" placeholder="输入关键词搜索" clearable>
                                        </el-input>
                                    </el-form-item>
                                    <el-form-item label="查询筛选">
                                        <el-checkbox v-model="filterForm.useRegex">正则匹配</el-checkbox>
                                    </el-form-item>
                                </el-form>
                                <el-button type="primary" style="width: 100%;" @click="applyFilter">搜索
                                </el-button>
                            </el-card>
                            <el-card style="margin-top: 20px;" v-loading="batchDeleting">
                                <div slot="header">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>已上传文件</span>
                                        <div>
                                            <el-checkbox
                                                v-if="files.length > 0"
                                                v-model="selectAll"
                                                @change="handleSelectAllChange"
                                                style="margin-right: 10px;"
                                            >
                                                全选
                                            </el-checkbox>
                                            <el-button
                                                v-if="selectedFileIds.length > 0"
                                                type="danger"
                                                size="mini"
                                                @click="batchRemoveFiles"
                                                :disabled="batchDeleting"
                                            >
                                                批量删除({{ selectedFileIds.length }})
                                            </el-button>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="files.length === 0">暂无文件</div>
                                <div v-else>
                                    <div v-for="(file,index) in files" :key="index" class="file-list"
                                         :class="{select: selectedFileIds.includes(file.id)}"
                                         @click.stop="toggleFileSelection(file.id)">
                                        <div style="display: flex; align-items: center;">
                                            <el-checkbox
                                                :value="selectedFileIds.includes(file.id)"
                                                @change.stop="(val) => handleFileSelectChange(val, file.id)"
                                                @click.stop
                                                style="margin-right: 10px;">
                                            </el-checkbox>
                                            <div style="flex: 1;">
                                                <span style="margin: 0;word-break: break-all;">{{ file.name }}</span>
                                                <div class="flex-row-center mt-5"
                                                     style="width:100%;justify-content: space-between;">
                                                    <span style="margin: 0; color: #909399;">{{ formatFileSize(file.size) }} • {{ file.total }} 条日志</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="delete-file-btn"  @click.stop="removeFile(file.id)">
                                            <i class="el-icon-close" style="color: #fff"></i>
                                        </div>
                                    </div>
                                </div>
                            </el-card>
                        </el-tab-pane>
                    </el-tabs>
                </el-main>
            </el-container>
        </div>
        <div class="content-area">
            <el-card style="width: 100%; min-height: 560px;" v-loading="loading">
                <div slot="header" class="clearfix">
                    <span>日志内容 总数:{{ totalLogs }}</span>
                    <el-button style="float: right; padding: 3px 0" type="text" @click.stop="analyzeLogs">AI分析</el-button>
                </div>
                <div v-if="loading">正在加载日志...</div>
                <div v-if="!currentFileId">请上传日志文件开始分析</div>
                <div v-if="currentFileId && logs.length === 0">
                    <el-empty description="暂无数据"></el-empty>
                </div>
                <div v-if="currentFileId && logs.length > 0">
                    <el-collapse accordion>
                        <el-collapse-item v-for="(log,index) in logs" :name="index" :key="index">
                            <template #title="{ isActive }">
                                <div class="log-entry" :class="{active:isActive}"
                                     :style="{borderLeft:getLevelColor(log.level)}">
                                    <div class="flex-row"
                                         style="font-size: 14px;white-space: nowrap;overflow: hidden;align-items: center;">
                                        <span class="log-message-time"
                                              v-if="!settingForm.showAll && settingForm.showTime">{{ formatTime(log.log_time) }}</span>
                                        <div class="log-message-thread" v-if="!settingForm.showAll && settingForm.showThread"
                                             :style="{color:settingForm.threadColor}">[{{ log.thread }}]
                                        </div>
                                        <div class="log-message-level" v-if="!settingForm.showAll && settingForm.showModule"
                                             :style="{color:settingForm.moduleColor}">[{{ log.module }}]
                                        </div>
                                        <div class="log-message-class" v-if="!settingForm.showAll && settingForm.showClass"
                                             :style="{color:settingForm.classColor}">[{{ log.class }}]
                                        </div>
                                        <div v-if="settingForm.showAll" style="flex: 1;padding-left: 2px;"
                                             :style="{color: settingForm.color}"
                                             v-html="highlightKeywords(log.content)">
                                        </div>
                                        <div v-else style="flex: 1;padding-left: 2px;"
                                             :style="{color: settingForm.color}"
                                             v-html="highlightKeywords(log.message)">
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div class="log-message" v-html="highlightKeywords(log.content)">
                            </div>
                        </el-collapse-item>
                    </el-collapse>

                    <div class="page-footer">
                        <el-pagination
                                v-if="totalLogs > 0"
                                @size-change="handleSizeChange"
                                @current-change="handlePageChange"
                                :current-page="currentPage + 1"
                                :page-size="pageSize"
                                :page-sizes="[100, 200, 500, 1000]"
                                layout="sizes,prev, pager, next, total"
                                :total="totalLogs"
                                style="margin-top: 20px; text-align: center;">
                        </el-pagination>
                        <div style="margin-top: 10px; text-align: center;">
                            <el-button
                                v-if="selectedFileIds.length > 1 && selectedFileIds.length !== files.length"
                                type="primary"
                                size="small"
                                @click="loadLogs"
                                :disabled="loading">
                                查询选中的 {{ selectedFileIds.length }} 个文件
                            </el-button>
                        </div>
                    </div>
                </div>
            </el-card>
        </div>
    </div>
    <el-dialog :visible.sync="showDialog" title="设置" width="80vw">
        <el-tabs>
            <el-tab-pane label="日志颜色">
                <el-card>
                    <el-form ref="form" :model="settingForm" label-width="80px">
                        <!-- 日志颜色 -->
                        <el-row>
                            <el-col :span="8">
                                <el-form-item label="日志颜色">
                                    <el-color-picker v-model="settingForm.color" show-alpha></el-color-picker>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="线程颜色">
                                    <el-color-picker v-model="settingForm.threadColor" show-alpha></el-color-picker>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="类名颜色">
                                    <el-color-picker v-model="settingForm.classColor" show-alpha></el-color-picker>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-form-item label="等级">
                            <div class="flex-row">
                                <div class="level-color-set" v-for="(value,key) in levelColorMap">
                                    <span style="margin: 0 5px;">{{ key }}</span>
                                    <el-color-picker v-model="levelColorMap[key]" show-alpha></el-color-picker>
                                </div>
                            </div>
                        </el-form-item>
                        <el-row>
                            <el-col :span="8">
                                <el-form-item label="显示时间">
                                    <el-switch v-model="settingForm.showTime" active-text="显示"
                                               inactive-text="隐藏"></el-switch>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="显示模块">
                                    <el-switch v-model="settingForm.showModule" active-text="显示"
                                               inactive-text="隐藏"></el-switch>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="显示线程">
                                    <el-switch v-model="settingForm.showThread" active-text="显示"
                                               inactive-text="隐藏"></el-switch>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="显示类名">
                                    <el-switch v-model="settingForm.showClass" active-text="显示" inactive-text="隐藏"></>
                                </el-form-item>
                            </el-col>
                        </el-row>


                    </el-form>
                </el-card>
            </el-tab-pane>
            <el-tab-pane label="项目配置">
                <el-card style="height: 60vh;">
                    <!-- 项目配置 projects 折叠配置 -->
                    <el-collapse accordion>
                        <el-collapse-item v-for="(project,index) in projectList" :name="index" :key="index">
                            <template #title="{ isActive }">
                                <div class="project-entry" :class="{active:isActive}"
                                     style="font-size: 14px;white-space: nowrap;overflow: hidden;">
                                    <div class="flex-row">
                                        <span class="project-name">{{ project.project_name }}</span>
                                    </div>
                                </div>
                            </template>
                        </el-collapse-item>
                    </el-collapse>
                </el-card>
            </el-tab-pane>
            <el-tab-pane label="AI日志正则">
                <el-card>
                    <div v-if="aiLoading===false && (!aiRuleRes || aiRuleRes==='')">
                        <span>提示：请输入日志示例</span>
                        <el-input v-model="logExample"></el-input>
                        <el-form :model="logRuleSet" label-width="80px">
                            <el-form-item label="时间">
                                <el-input v-model="logRuleSet.time"></el-input>
                            </el-form-item>
                            <el-form-item label="线程">
                                <el-input v-model="logRuleSet.thread"></el-input>
                            </el-form-item>
                            <el-form-item label="类名">
                                <el-input v-model="logRuleSet.class"></el-input>
                            </el-form-item>
                            <el-form-item label="等级">
                                <el-input v-model="logRuleSet.level"></el-input>
                            </el-form-item>
                            <el-form-item label="内容">
                                <el-input v-model="logRuleSet.message"></el-input>
                            </el-form-item>
                        </el-form>
                    </div>
                    <div style="width: 100%;display: flex;flex-direction: column;align-items: center;justify-content: center;">
                        <div v-if="aiLoading" class="loader"></div>
                        <div v-if="aiRuleRes">
                            <i class="el-icon-success" style="font-size: 64px;color: #13ce66;"></i>
                            <div class="" style="white-space: pre-line;">
                                <div v-html="buildMarkdownCode(aiRuleRes)"></div>
                            </div>
                        </div>
                    </div>
                    <el-button v-if="!aiRuleRes || aiRuleRes===''" type="primary" style="margin-top: 20px;width: 100%;"
                               @click="aiGenerateLogRule">AI生成
                    </el-button>
                    <el-button v-if="aiRuleRes && aiRuleRes!==''" type="primary" style="margin-top: 20px;width: 100%;"
                               @click="resetGenerateLogRule">重新生成
                    </el-button>
                </el-card>
            </el-tab-pane>
        </el-tabs>
    </el-dialog>
    <el-dialog :visible.sync="aiShow" title="AI日志分析" width="80vw">
        <el-card style="height: 70vh;">
            <div ref="aiContentRef" style="width:100%;height:calc(70vh - 40px);overflow-y: auto;">
                <div v-if="aiLoading"
                     style="display: flex;flex-direction: column;align-items: center;justify-content: center ;">
                    <div class="loader"></div>
                    <span>AI 分析中...</span>
                </div>
                <div v-if="aiRes.length > 0" style="width: 100%">
                    <i class="el-icon-success" style="font-size: 64px;color: #13ce66;"></i>
                    <div class="" style="white-space: pre-line;">
                        <div v-html="buildMarkdownCode(aiRes)"></div>
                    </div>
                </div>
            </div>
        </el-card>
    </el-dialog>
</div>
<script>hljs.highlightAll();</script>
<script src="/static/js/app.js?v=2025"></script>
</body>
</html>
